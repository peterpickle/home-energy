{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Home Heating</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="{% static 'home_heating/favicon.ico' %}" sizes="any">
    <link rel="apple-touch-icon" href="{% static 'home_heating/apple-touch-icon.png' %}">
    <link rel="stylesheet" href="{% static 'home_heating/index.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
    function getDayOfWeek(date) {
        return date.toLocaleString('en-us', {  weekday: 'long' });
    }

    function getFieldOutputName(fieldName) {
        outputFieldName = fieldName;
        if (fieldName.includes(".")) {
            outputFieldName = fieldName.split(".", 1)[0];
        }
        return outputFieldName;
    }

    function getEbusValue(circuit, fieldName) {
        url = "get/" + circuit + "/" + fieldName;
        $.getJSON(url,
            function(value) {
                updateValueInUI(circuit, fieldName, getFieldOutputName(fieldName), value);
            }
        );
    }

    function setEbusValue(circuit, fieldName, value) {
        url = "set/" + circuit + "/" + fieldName+ "/" + value;
        $.getJSON(url,
            function(response) {
                if (response == "done") {
                    updateValueInUI(circuit, fieldName, getFieldOutputName(fieldName), value);
                }
            }
        );
    }

    function incValue(circuit, fieldName, incValue) {
        currentValue = parseFloat($("#current_"+ circuit + "_" + fieldName + "_div").text());
        if (currentValue == "NaN") {
            return;
        }
        newValue = currentValue + incValue;
        setEbusValue(circuit, fieldName, newValue);
    }

    function setSchedule(circuit, fieldName, allDays) {
        oldValue = $("#current_"+ circuit + "_" + fieldName + "_div").text();
        newValue = "";

        for(i = 0; i < 6; i++) {
            if (i != 0) {
                newValue += ";";
            }
            newValue += $("#" + circuit + "_" + fieldName + "_" + i).val();
        }

        if (newValue != oldValue) {
            //TODO: validate new value
            n = allDays ? 7 : 1;
            for (i = 0; i < n; i++) {
                d = new Date();
                d.setDate(d.getDate() + i);
                setEbusValue(circuit, fieldName + "." +  getDayOfWeek(d), newValue);
            }
        }
    }

    function getAllEbusValues() {
        getEbusValue("700", "z1RoomTemp");
        getEbusValue("700", "z1DayTemp");
        getEbusValue("700", "z1NightTemp");
        getEbusValue("700", "z1ActualRoomTempDesired");
        getEbusValue("700", "DisplayedOutsideTemp");
        getEbusValue("700", "DisplayedOutsideTemp");
        getEbusValue("700", "z1Timer." + getDayOfWeek(new Date()));

        getEbusValue("700", "HwcStorageTemp");
        getEbusValue("700", "HwcTempDesired");
        getEbusValue("700", "CylinderChargeHyst");
        getEbusValue("700", "HwcOpMode");
        getEbusValue("700", "hwcTimer." + getDayOfWeek(new Date()));

        getEbusValue("hmu", "State");
        getEbusValue("hmu", "currenterror");
    }

    function updateValueInUI(circuit, fieldName, outputFieldName, newValue) {
        if (fieldName.includes("Timer")) {
            $("#current_"+ circuit + "_" + outputFieldName + "_div").text(newValue);
            times = newValue.split(";", 6);
            if (times.length == 6) {
                for(i = 0; i < times.length; i++) {
                    $("#" + circuit + "_" + outputFieldName + "_" + i).val(times[i]);
                }
            }
        } else {
            $("#current_"+ circuit + "_" + outputFieldName + "_div").text(newValue);
        }
    }

    function uiAddOptionsForTimeSelect() {
        timeSelects = $("select");
        timeSelects.each(
            function(i) {
                $(this).append('<option value="-:-">--:--</option>');
                for(h = 0; h < 24; h++) {
                    for(m = 0; m < 60; m+=10) {
                        optionValue = h.toString().padStart(2, "0") + ":" + m.toString().padStart(2, "0");
                        $(this).append('<option value="' + optionValue +'">' + optionValue + '</option>');
                    }
                }
            }
        );
    }

    window.onload = function() {
        uiAddOptionsForTimeSelect();

        getAllEbusValues();

        $("h2").click(function() {
            getAllEbusValues();
        });

        $("#dec_700_z1DayTemp").click(function() {
            incValue("700", "z1DayTemp", -0.5);
        });
        $("#inc_700_z1DayTemp").click(function() {
            incValue("700", "z1DayTemp", +0.5);
        });

        $("#dec_700_z1NightTemp").click(function() {
            incValue("700", "z1NightTemp", -0.5);
        });
        $("#inc_700_z1NightTemp").click(function() {
            incValue("700", "z1NightTemp", +0.5);
        });

        $("#set_700_z1Timer").click(function() {
            setSchedule("700", "z1Timer", true);
        });

        $("#dec_700_HwcTempDesired").click(function() {
            incValue("700", "HwcTempDesired", -1);
        });
        $("#inc_700_HwcTempDesired").click(function() {
            incValue("700", "HwcTempDesired", +1);
        });

        $("#dec_700_CylinderChargeHyst").click(function() {
            incValue("700", "CylinderChargeHyst", -1);
        });
        $("#inc_700_CylinderChargeHyst").click(function() {
            incValue("700", "CylinderChargeHyst", +1);
        });

        $("#set_700_hwcTimer").click(function() {
            setSchedule("700", "hwcTimer", true);
        });

    }

    </script>
</head>
<body>
    <h2>Heating</h2>
    Room temp: <div id="current_700_z1RoomTemp_div" class="current_value"></div>
    <br/>

    <input type="button" id="dec_700_z1DayTemp" value="-"/>
    Day temp: <div id="current_700_z1DayTemp_div" class="current_value"></div>
    <input type="button" id="inc_700_z1DayTemp" value="+"/>
    <br/>

    <input type="button" id="dec_700_z1NightTemp" value="-"/>
    Night temp: <div id="current_700_z1NightTemp_div" class="current_value"></div>
    <input type="button" id="inc_700_z1NightTemp" value="+"/>
    <br/>

    Desired temp: <div id="current_700_z1ActualRoomTempDesired_div" class="current_value"></div>
    <br/>
    Outside Temp: <div id="current_700_DisplayedOutsideTemp_div" class="current_value"></div>
    <br/>

    Schedule:
    <div id="current_700_z1Timer_div" class="current_value" style="display: none;"></div>
    <div>
        <select id="700_z1Timer_0"></select>
        <select id="700_z1Timer_1"></select>
        <br/>
        <select id="700_z1Timer_2"></select>
        <select id="700_z1Timer_3"></select>
        <br/>
        <select id="700_z1Timer_4"></select>
        <select id="700_z1Timer_5"></select>
        <br/>
        <input type="button" id="set_700_z1Timer" value="Set"/>
    </div>
    <br/>

    <!-- TODO: show humidity -->

    <h2>Water</h2>
    Current temp: <div id="current_700_HwcStorageTemp_div" class="current_value"></div>
    <br/>

    <input type="button" id="dec_700_HwcTempDesired" value="-"/>
    Desired temp: <div id="current_700_HwcTempDesired_div" class="current_value"></div>
    <input type="button" id="inc_700_HwcTempDesired" value="+"/>
    <br/>

    <input type="button" id="dec_700_CylinderChargeHyst" value="-"/>
    Hyst: <div id="current_700_CylinderChargeHyst_div" class="current_value"></div>
    <input type="button" id="inc_700_CylinderChargeHyst" value="+"/>
    <br/>

    Mode: <div id="current_700_HwcOpMode_div" class="current_value"></div>
    <br/>

    Schedule:
    <div id="current_700_hwcTimer_div" class="current_value" style="display: none;"></div>
    <div>
        <select id="700_hwcTimer_0"></select>
        <select id="700_hwcTimer_1"></select>
        <br/>
        <select id="700_hwcTimer_2"></select>
        <select id="700_hwcTimer_3"></select>
        <br/>
        <select id="700_hwcTimer_4"></select>
        <select id="700_hwcTimer_5"></select>
        <br/>
        <input type="button" id="set_700_hwcTimer" value="Set"/>
    </div>
    <br/>

    <!-- TODO: show Legionella Day + Hour -->

    <h2>General</h2>
    State: <div id="current_hmu_State_div" class="current_value"></div>
    <br/>

    Error: <div id="current_hmu_currenterror_div" class="current_value"></div>
    <br/>
</body>
</html>
